<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>To Do Lee'st</title>
<style>
Â  :root{
Â  Â  --bg:#0f1115;--panel:#171a21;--text:#ffffff;--muted:#a6adbb;--border:#242937;
Â  Â  --pri:#8ab4f8;--acc:#55d3a6;--danger:#e84545;
Â  Â  --btn:#222a41; --btn-hover:#2a3555;
Â  Â  --pop:#0f1422; --pop-border:#2b3550;
Â  Â  --prog-track:#111827;
Â  Â  --prog-glow:rgba(138,180,248,.12);
Â  Â  --grad1:#8ab4f8; --grad2:#7dd3fc; --grad3:#55d3a6;
Â  }
Â  body.light{
Â  Â  --bg:#f6f7fb;--panel:#ffffff;--text:#0e1320;--muted:#5f6b84;--border:#e3e8f4;
Â  Â  --pri:#246bff;--acc:#0fa66e;--danger:#d43d3d;
Â  Â  --btn:#eef3ff; --btn-hover:#e3ecff;
Â  Â  --pop:#ffffff; --pop-border:#e3e8f4;
Â  Â  --prog-track:#eaf1ff;
Â  Â  --prog-glow:rgba(36,107,255,.12);
Â  Â  --grad1:#246bff; --grad2:#60a5fa; --grad3:#0fa66e;
Â  }
Â  *{box-sizing:border-box}
Â  html,body{height:100%;margin:0;background:radial-gradient(1100px 600px at 20% -10%, rgba(31,36,51,.8), var(--bg));color:var(--text);
Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,Arial,sans-serif}
Â  .app{max-width:1060px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr 1fr;gap:16px}
Â  @media (max-width: 900px){ .app{grid-template-columns:1fr;max-width:720px} }
Â  .panel{padding:14px;border:1px solid var(--border);border-radius:16px;background:var(--panel)}
Â  h1{margin:0 0 8px 0;font-size:22px}
Â  .muted{color:var(--muted)}
Â  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
Â  .space{justify-content:space-between}
Â  .btn{cursor:pointer;border:1px solid var(--border);border-radius:12px;background:var(--btn);color:var(--text);padding:10px 12px}
Â  .btn:hover{background:var(--btn-hover)}
Â  .btn-acc{color:var(--acc)} .btn-pri{color:var(--pri)} .btn-danger{color:var(--danger);border-color:#3a262b}
Â  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#111625}
Â  body.light .pill{background:#f2f5ff}
Â  input[type=text]{ padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#101521;color:var(--text);outline:none }
Â  body.light input[type=text]{ background:#fff;color:var(--text) }
Â  input::placeholder{color:#c2c8d6} body.light input::placeholder{color:#6c7387}

Â  .cal{display:grid;grid-template-rows:auto 1fr;gap:10px}
Â  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
Â  .dow{font-size:12px;color:var(--muted);text-align:center}
Â  .cell{border:1px solid var(--border);border-radius:14px;background:#141927;padding:8px;min-height:84px;display:flex;flex-direction:column;gap:6px;position:relative;color:var(--text)}
Â  body.light .cell{background:#fff;color:var(--text)}
Â  .cell.other{opacity:.45}
Â  .cell .top{display:flex;justify-content:space-between;align-items:center}
Â  .date{font-weight:700;font-size:13px;color:var(--text)}
Â  .ring{width:18px;height:18px;border-radius:50%;background: conic-gradient(var(--acc) calc(var(--p,0)*1%), #263047 0);}
Â  body.light .ring{background: conic-gradient(var(--acc) calc(var(--p,0)*1%), #dde5ff 0);}
Â  .cell.today{outline:1px solid var(--pri)}
Â  .cell.sel{box-shadow:0 0 0 2px var(--pri) inset}
Â  .cell:hover{background:#1b2338}
Â  body.light .cell:hover{background:#f3f6ff}

Â  .addrow{display:grid;grid-template-columns:1fr 44px;gap:8px}
Â  ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
Â  li.item{display:grid;grid-template-columns:26px minmax(140px,1fr) auto;gap:10px;align-items:center;
Â  Â  padding:10px;border:1px solid var(--border);border-radius:14px;background:#141927; position:relative; overflow:visible}
Â  body.light li.item{background:#fff}
Â  li.item input[type=checkbox]{transform:scale(1.2)}
Â  .txtwrap{display:flex;align-items:center;gap:6px;min-width:140px}
Â  li.item .txt{white-space:nowrap; overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; padding-bottom:2px; color:var(--text); flex:1}
Â  li.item.done .txt{color:var(--muted); text-decoration:line-through}
Â  .badge{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted);white-space:nowrap}
Â  .badge.overdue{color:#fff;background:var(--danger);border-color:transparent}
Â  .actions{display:flex;gap:4px;align-items:center;flex-wrap:nowrap; position:relative }
Â  .icon{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;padding:6px 8px;cursor:pointer;min-width:36px}
Â  .icon:hover{background:#1d2742} body.light .icon:hover{background:#eaf0ff}

Â  .duePortal{ position:fixed; inset:0; z-index:9999; pointer-events:none }
Â  .due-pop{ position:absolute; width:320px; max-height:360px; display:flex; flex-direction:column;
Â  Â  Â  Â  Â  Â  background:var(--pop); border:1px solid var(--pop-border); border-radius:12px;
Â  Â  Â  Â  Â  Â  box-shadow:0 8px 24px rgba(0,0,0,.35); pointer-events:auto }
Â  .due-head{ display:flex; align-items:center; justify-content:space-between; padding:8px; position:sticky; top:0; background:var(--pop); border-bottom:1px solid var(--pop-border) }
Â  .due-head .title{ font-weight:700 }
Â  .due-cal{ padding:8px }
Â  .due-dow{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; font-size:12px; color:var(--muted); text-align:center }
Â  .due-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
Â  .dcell{ padding:8px 0; text-align:center; border:1px solid var(--pop-border); border-radius:10px; cursor:pointer; user-select:none }
Â  .dcell.other{ opacity:.4 }
Â  .dcell.today{ outline:1px solid var(--pri) }
Â  .dcell.sel{ background:rgba(136,178,255,.15); border-color:var(--pri) }
Â  .due-time{ padding:8px; display:flex; gap:8px; align-items:center; border-top:1px dashed var(--pop-border) }
Â  .timebox{ display:flex; gap:6px; align-items:center }
Â  select{ border:1px solid var(--pop-border); background:transparent; color:var(--text); border-radius:10px; padding:6px 10px }
Â  body.light select{ background:#fff; color:var(--text) }
Â  .actionbar{ position:sticky; bottom:0; display:flex; gap:8px; justify-content:flex-end; padding:8px; background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.06) 30%, var(--pop) 60%); border-top:1px solid var(--pop-border) }
Â  .btn-save{ background:var(--acc); color:#0b1220; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700 }
Â  .btn-cancel{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer }

Â  .progwrap{ margin:12px -4px 0; }
Â  .progwrap .row{ padding:0 4px }
Â  progress{
Â  Â  width:calc(100% + 8px);
Â  Â  margin:6px -4px 0;
Â  Â  height:24px;
Â  Â  border:0;
Â  Â  border-radius:999px;
Â  Â  background:var(--prog-track);
Â  Â  box-shadow:
Â  Â  Â  inset 0 1px 0 rgba(255,255,255,.05),
Â  Â  Â  0 0 0 1px var(--border),
Â  Â  Â  0 6px 18px var(--prog-glow);
Â  Â  overflow:hidden;
Â  }
Â  progress::-webkit-progress-bar{ background:transparent; border-radius:999px }
Â  progress::-webkit-progress-value{
Â  Â  border-radius:999px;
Â  Â  background:linear-gradient(90deg, var(--grad1) 0%, var(--grad2) 50%, var(--grad3) 100%);
Â  Â  transition:width .25s ease;
Â  }
Â  progress::-moz-progress-bar{
Â  Â  border-radius:999px;
Â  Â  background:linear-gradient(90deg, var(--grad1) 0%, var(--grad2) 50%, var(--grad3) 100%);
Â  Â  transition:width .25s ease;
Â  }
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3323631723585454"
     crossorigin="anonymous"></script>
</head>
<body>
Â  <div class="app">

Â  Â  <section class="panel cal">
Â  Â  Â  <div class="row space">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="prevMonth" class="btn" title="ì´ì „ ë‹¬" type="button">â—€</button>
Â  Â  Â  Â  Â  <button id="todayBtn" class="btn btn-pri" title="ì˜¤ëŠ˜" type="button">ì˜¤ëŠ˜</button>
Â  Â  Â  Â  Â  <button id="nextMonth" class="btn" title="ë‹¤ìŒ ë‹¬" type="button">â–¶</button>
Â  Â  Â  Â  Â  <h1 id="monthTitle" style="margin-left:8px">2025ë…„ 9ì›”</h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="themeToggle" class="btn" type="button">Dark/Light</button>
Â  Â  Â  Â  Â  <button id="openPiP" class="btn btn-acc" type="button">PiP ì—´ê¸°</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="grid">
Â  Â  Â  Â  <div class="dow">ì¼</div><div class="dow">ì›”</div><div class="dow">í™”</div><div class="dow">ìˆ˜</div><div class="dow">ëª©</div><div class="dow">ê¸ˆ</div><div class="dow">í† </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="grid" id="calGrid" aria-label="month-grid"></div>
Â  Â  </section>

Â  Â  <section class="panel">
Â  Â  Â  <div class="row space">
Â  Â  Â  Â  <div class="row wrap">
Â  Â  Â  Â  Â  <h1 id="dayTitle" style="margin:0">2025-09-16</h1>
Â  Â  Â  Â  Â  <span class="pill"><span class="muted">ì™„ë£Œ/ì „ì²´</span> <strong id="doneTotal">0/0</strong></span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="rolloverBtn" class="btn" type="button">ë¯¸ì™„ë£Œ ì´ì›”â†’ë‹¤ìŒë‚ </button>
Â  Â  Â  Â  Â  <button id="clearDone" class="btn ghost" type="button">ì™„ë£Œ ì‚­ì œ</button>
Â  Â  Â  Â  Â  <button id="clearAll" class="btn btn-danger ghost" type="button">ì „ì²´ ì‚­ì œ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="addrow" style="margin-top:10px">
Â  Â  Â  Â  <input id="taskInput" type="text" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ê³  Enter" autocomplete="off">
Â  Â  Â  Â  <button id="addBtn" class="btn btn-acc" title="ì¶”ê°€" type="button">ï¼‹</button>
Â  Â  Â  </div>

Â  Â  Â  <ul id="list" style="margin-top:10px"></ul>

Â  Â  Â  <div class="progwrap">
Â  Â  Â  Â  <div class="row space">
Â  Â  Â  Â  Â  <span id="progText">ì™„ë£Œ/ì „ì²´ 0%</span>
Â  Â  Â  Â  Â  <span class="muted" id="counter">0 / 0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <progress id="progBar" value="0" max="100"></progress>
Â  Â  Â  </div>
Â  Â  </section>
Â  </div>

Â  <template id="pip-template">
Â  Â  <div class="pip" style="padding:10px">
Â  Â  Â  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
Â  Â  Â  Â  <strong>í•  ì¼</strong> <small id="pipDate" class="muted"></small>
Â  Â  Â  </header>
Â  Â  Â  <ul id="list"></ul>
Â  Â  Â  <div class="progwrap" style="margin-top:8px">
Â  Â  Â  Â  <div class="row space">
Â  Â  Â  Â  Â  <span id="progText">ì™„ë£Œ/ì „ì²´ 0%</span>
Â  Â  Â  Â  Â  <span class="muted" id="counter">0 / 0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <progress id="progBar" value="0" max="100"></progress>
Â  Â  Â  </div>
Â  Â  </div>
Â  </template>

Â  <div id="due-portal" class="duePortal" style="display:none"></div>

<script>
(() => {
Â  const TASKS_KEY = 'cal_todos_v2';
Â  const SEL_KEYÂ  Â = 'cal_selected_v1';
Â  const ROLL_KEYÂ  = 'cal_rollover_v1';
Â  const PREF_KEYÂ  = 'cal_prefs_v1';
Â  const REV_KEYÂ  Â = 'cal_rev_v1';
Â  const bc = new BroadcastChannel('CAL_TODO_SYNC_V1');

Â  const REPEAT_ORDER = ['none','daily','weekly','monthly'];
Â  function ymd(d){ const y=d.getFullYear(), m=(''+(d.getMonth()+1)).padStart(2,'0'), dd=(''+d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
Â  function addDays(d,n){ const r=new Date(d); r.setDate(r.getDate()+n); return r; }
Â  function startOfMonth(d){ const r=new Date(d); r.setDate(1); r.setHours(0,0,0,0); return r; }
Â  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
Â  function fmtMonth(d){ return new Intl.DateTimeFormat('ko-KR',{year:'numeric',month:'long'}).format(d); }
Â  function fmtDue(ts){ if(!ts) return ''; return new Intl.DateTimeFormat('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(ts)); }
Â  function cycleRepeat(cur){ const i = REPEAT_ORDER.indexOf(cur||'none'); return REPEAT_ORDER[(i+1)%REPEAT_ORDER.length]; }

Â  function loadMap(key){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch{ return {}; } }
Â  function saveMap(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
Â  function bumpRev(ctx=window){ const n = Number(ctx.localStorage.getItem(REV_KEY)||'0')+1; ctx.localStorage.setItem(REV_KEY, String(n)); return n; }
Â  function getSelected(ctx=window){ return ctx.localStorage.getItem(SEL_KEY) || ymd(new Date()); }
Â  function setSelected(key){ localStorage.setItem(SEL_KEY, key); bc.postMessage({type:'date', key}); bumpRev(); }

Â  function getTasks(key, ctx=window){ const map = (()=>{ try{ return JSON.parse(ctx.localStorage.getItem(TASKS_KEY)||'{}'); }catch{ return {}; } })(); return map[key] || []; }
Â  function setTasks(key, arr, ctx=window, channel=bc){ const map = (()=>{ try{ return JSON.parse(ctx.localStorage.getItem(TASKS_KEY)||'{}'); }catch{ return {}; } })(); map[key] = arr; ctx.localStorage.setItem(TASKS_KEY, JSON.stringify(map)); channel.postMessage({type:'tasks', key}); bumpRev(ctx); }

Â  function makeTask(text){ return { id: crypto.randomUUID(), text, done:false, createdAt: Date.now(), repeat:'none', dueAt:null }; }

Â  function nextRepeatDate(dateKey, repeat){
Â  Â  const [y,m,d] = dateKey.split('-').map(Number);
Â  Â  const base = new Date(y, m-1, d);
Â  Â  if (repeat==='daily') return ymd(addDays(base, 1));
Â  Â  if (repeat==='weekly') return ymd(addDays(base, 7));
Â  Â  if (repeat==='monthly'){ const n=new Date(y, m-1, d); n.setMonth(n.getMonth()+1); return ymd(n); }
Â  Â  return null;
Â  }

Â  function requestNotify(){ if (!('Notification' in window)) return; if (Notification.permission === 'default'){ Notification.requestPermission(); } }
Â  function maybeNotify(task, key){
Â  Â  if (!('Notification' in window) || Notification.permission!=='granted') return;
Â  Â  const now = Date.now();
Â  Â  if (task.dueAt && !task.done && task.dueAt <= now){ new Notification('í•  ì¼ ë§ˆê°', { body: `[${key}] ${task.text}` }); }
Â  }

Â  function runDailyRollover(){
Â  Â  const todayKey = ymd(new Date());
Â  Â  const last = localStorage.getItem(ROLL_KEY)||'';
Â  Â  if (last === todayKey) return;
Â  Â  const yKey = ymd(addDays(new Date(), -1));
Â  Â  const map = loadMap(TASKS_KEY);
Â  Â  const yTasks = (map[yKey]||[]);
Â  Â  if (yTasks.length){
Â  Â  Â  const undone = yTasks.filter(t=>!t.done);
Â  Â  Â  if (undone.length){
Â  Â  Â  Â  map[yKey] = yTasks.filter(t=>t.done);
Â  Â  Â  Â  const nextArr = (map[todayKey]||[]);
Â  Â  Â  Â  map[todayKey] = nextArr.concat(undone.map(t=>({ ...t })));
Â  Â  Â  Â  saveMap(TASKS_KEY, map);
Â  Â  Â  Â  bc.postMessage({type:'tasks', key: todayKey});
Â  Â  Â  Â  bumpRev();
Â  Â  Â  }
Â  Â  }
Â  Â  localStorage.setItem(ROLL_KEY, todayKey);
Â  }

Â  function getPrefs(){ try{ return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); }catch{ return {}; } }
Â  function setPrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }
Â  function applyTheme(){ const p = getPrefs(); document.body.classList.toggle('light', p.theme==='light'); }

Â  const state = { month: new Date(), sel: new Date(getSelected()) };
Â  state.month = new Date(state.sel.getFullYear(), state.sel.getMonth(), 1);

Â  const monthTitle = document.getElementById('monthTitle');
Â  const calGrid = document.getElementById('calGrid');
Â  const dayTitle = document.getElementById('dayTitle');
Â  const doneTotal = document.getElementById('doneTotal');
Â  const progText = document.getElementById('progText');
Â  const counter = document.getElementById('counter');
Â  const progBar = document.getElementById('progBar');
Â  const taskInput = document.getElementById('taskInput');
Â  const addBtn = document.getElementById('addBtn');
Â  const list = document.getElementById('list');
Â  const clearDoneBtn = document.getElementById('clearDone');
Â  const clearAllBtn = document.getElementById('clearAll');
Â  const rolloverBtn = document.getElementById('rolloverBtn');
Â  const duePortal = document.getElementById('due-portal');

Â  function renderCalendar(){
Â  Â  const first = startOfMonth(state.month);
Â  Â  const startWeekday = first.getDay();
Â  Â  const gridStart = addDays(first, -startWeekday);
Â  Â  const today = new Date();
Â  Â  const selKey = getSelected();

Â  Â  monthTitle.textContent = fmtMonth(state.month);
Â  Â  calGrid.innerHTML = '';

Â  Â  for (let i=0;i<42;i++){
Â  Â  Â  const day = addDays(gridStart, i);
Â  Â  Â  const key = ymd(day);
Â  Â  Â  const cell = document.createElement('button');
Â  Â  Â  cell.className = 'cell'; cell.type='button';
Â  Â  Â  if (day.getMonth() !== state.month.getMonth()) cell.classList.add('other');
Â  Â  Â  if (sameDay(day, today)) cell.classList.add('today');
Â  Â  Â  if (key === selKey) cell.classList.add('sel');

Â  Â  Â  const ts = getTasks(key); const total = ts.length; const done = ts.filter(t=>t.done).length;
Â  Â  Â  const pct = total? Math.round(done/total*100) : 0;
Â  Â  Â  cell.innerHTML = `
Â  Â  Â  Â  <div class="top">
Â  Â  Â  Â  Â  <span class="date">${day.getDate()}</span>
Â  Â  Â  Â  Â  <span class="ring" style="--p:${pct}"></span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" style="font-size:12px">${total? `${done}/${total}` : '&nbsp;'}</div>
Â  Â  Â  `;
Â  Â  Â  cell.addEventListener('click', ()=>{
Â  Â  Â  Â  state.sel = day;
Â  Â  Â  Â  setSelected(key);
Â  Â  Â  Â  renderCalendar(); renderDay();
Â  Â  Â  });
Â  Â  Â  calGrid.appendChild(cell);
Â  Â  }
Â  }

Â  function renderDay(){
Â  Â  const key = getSelected();
Â  Â  dayTitle.textContent = key;

Â  Â  const tasks = getTasks(key);
Â  Â  const total = tasks.length, done = tasks.filter(t=>t.done).length;
Â  Â  list.innerHTML = '';
Â  Â  tasks.forEach(item => {
Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  li.className = 'item' + (item.done ? ' done': '');
Â  Â  Â  li.dataset.id = item.id;
Â  Â  Â  const dueLabel = item.dueAt ? fmtDue(item.dueAt) : '';
Â  Â  Â  const overdue = item.dueAt && !item.done && item.dueAt <= Date.now();
Â  Â  Â  const repLabel = (item.repeat && item.repeat!=='none') ? (item.repeat==='daily'?'ë§¤ì¼':item.repeat==='weekly'?'ë§¤ì£¼':'ë§¤ì›”') : '';

Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  <input type="checkbox" ${item.done?'checked':''} aria-label="ì™„ë£Œ">
Â  Â  Â  Â  <div class="txtwrap">
Â  Â  Â  Â  Â  <div class="txt" contenteditable="true" spellcheck="false"></div>
Â  Â  Â  Â  Â  ${repLabel? `<span class="badge rep" title="ë°˜ë³µ">${repLabel}</span>`:''}
Â  Â  Â  Â  Â  ${dueLabel? `<span class="badge ${overdue?'overdue':''}" title="ë§ˆê°">${dueLabel}</span>`:''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  <button class="icon" data-act="rep" title="ë°˜ë³µ ì „í™˜(ì—†ìŒâ†’ë§¤ì¼â†’ë§¤ì£¼â†’ë§¤ì›”)">â†»</button>
Â  Â  Â  Â  Â  <button class="icon" data-act="due" title="ë§ˆê° ë‚ ì§œÂ·ì‹œê°„ ì„¤ì •">ğŸ“…</button>
Â  Â  Â  Â  Â  <button class="icon" data-act="del" title="ì‚­ì œ">ğŸ—‘</button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  li.querySelector('.txt').textContent = item.text;
Â  Â  Â  list.appendChild(li);
Â  Â  Â  if (overdue){ li.style.outline = '2px solid var(--danger)'; } else { li.style.outline = ''; }
Â  Â  });

Â  Â  const ratio = total? Math.round(done/total*100):0;
Â  Â  progText.textContent = `ì™„ë£Œ/ì „ì²´ ${ratio}%`;
Â  Â  counter.textContent = `${done} / ${total}`;
Â  Â  progBar.value = ratio;
Â  Â  doneTotal.textContent = `${done}/${total}`;
Â  }

Â  function addTask(){
Â  Â  const key = getSelected();
Â  Â  const text = (taskInput.value||'').trim();
Â  Â  if (!text) return;
Â  Â  const arr = getTasks(key); arr.push(makeTask(text)); setTasks(key, arr);
Â  Â  taskInput.value='';
Â  Â  renderDay(); renderCalendar();
Â  }

Â  addBtn.addEventListener('click', addTask);
Â  taskInput.addEventListener('keydown', (e)=>{ if (e.isComposing) return; if (e.key==='Enter'){ e.preventDefault(); addTask(); } });

Â  list.addEventListener('keydown', (e)=>{ if (e.target.matches('.txt') && e.key==='Enter'){ e.preventDefault(); } });

Â  list.addEventListener('change', (e)=>{
Â  Â  const key = getSelected();
Â  Â  if (e.target.matches('input[type=checkbox]')){
Â  Â  Â  const id = e.target.closest('.item')?.dataset.id;
Â  Â  Â  const arr = getTasks(key);
Â  Â  Â  const i = arr.findIndex(t=>t.id===id);
Â  Â  Â  if (i>=0){
Â  Â  Â  Â  const wasDone = arr[i].done;
Â  Â  Â  Â  arr[i].done = !!e.target.checked;
Â  Â  Â  Â  setTasks(key, arr);
Â  Â  Â  Â  if (!wasDone && arr[i].done && arr[i].repeat && arr[i].repeat!=='none'){
Â  Â  Â  Â  Â  const nextKey = nextRepeatDate(key, arr[i].repeat);
Â  Â  Â  Â  Â  if (nextKey){
Â  Â  Â  Â  Â  Â  const clone = { ...arr[i], id: crypto.randomUUID(), done:false };
Â  Â  Â  Â  Â  Â  if (clone.dueAt){
Â  Â  Â  Â  Â  Â  Â  const old=new Date(clone.dueAt); let next=new Date(old);
Â  Â  Â  Â  Â  Â  Â  if (arr[i].repeat==='daily') next = addDays(old,1);
Â  Â  Â  Â  Â  Â  Â  else if (arr[i].repeat==='weekly') next = addDays(old,7);
Â  Â  Â  Â  Â  Â  Â  else if (arr[i].repeat==='monthly'){ next.setMonth(next.getMonth()+1); }
Â  Â  Â  Â  Â  Â  Â  clone.dueAt = next.getTime();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const nextArr = getTasks(nextKey); nextArr.push(clone); setTasks(nextKey, nextArr);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  renderDay(); renderCalendar();
Â  Â  Â  }
Â  Â  }
Â  });

Â  function buildCalendarContent(currentTs){
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = 'due-pop';
Â  Â  const now = currentTs ? new Date(currentTs) : new Date();
Â  Â  const state = { view: new Date(now.getFullYear(), now.getMonth(), 1), sel: new Date(now) };

Â  Â  const head = document.createElement('div'); head.className = 'due-head';
Â  Â  head.innerHTML = `<button class="icon" data-nav="-1" title="ì´ì „ ë‹¬">â—€</button><div class="title">${fmtMonth(state.view)}</div><button class="icon" data-nav="1" title="ë‹¤ìŒ ë‹¬">â–¶</button>`;

Â  Â  const cal = document.createElement('div'); cal.className = 'due-cal';
Â  Â  const dow = document.createElement('div'); dow.className = 'due-dow';
Â  Â  dow.innerHTML = '<div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>';
Â  Â  const grid = document.createElement('div'); grid.className = 'due-grid';

Â  Â  const time = document.createElement('div'); time.className = 'due-time';
Â  Â  const hourSel = document.createElement('select'); const minSel = document.createElement('select');
Â  Â  for(let h=0;h<24;h++){ const o=document.createElement('option'); o.value=String(h); o.textContent=(h+'').padStart(2,'0'); hourSel.appendChild(o); }
Â  Â  for(let m=0;m<60;m+=5){ const o=document.createElement('option'); o.value=String(m); o.textContent=(m+'').padStart(2,'0'); minSel.appendChild(o); }
Â  Â  hourSel.value = String(state.sel.getHours());
Â  Â  minSel.value = String(Math.round(state.sel.getMinutes()/5)*5 % 60);
Â  Â  time.innerHTML = `<span class="muted">ì‹œê°„</span>`;
Â  Â  const tb = document.createElement('div'); tb.className='timebox'; tb.append(hourSel, document.createTextNode(' : '), minSel);
Â  Â  time.appendChild(tb);

Â  Â  const actions = document.createElement('div'); actions.className='actionbar';
Â  Â  actions.innerHTML = `<button class="btn-cancel" data-act="due-cancel">ì·¨ì†Œ</button><button class="btn-save" data-act="due-save">ì €ì¥</button>`;

Â  Â  cal.append(dow, grid);
Â  Â  wrapper.append(head, cal, time, actions);

Â  Â  function fillGrid(){
Â  Â  Â  grid.innerHTML='';
Â  Â  Â  const first = new Date(state.view); first.setDate(1);
Â  Â  Â  const start = new Date(first); start.setDate(1 - first.getDay());
Â  Â  Â  const today = new Date();
Â  Â  Â  for(let i=0;i<42;i++){
Â  Â  Â  Â  const d = addDays(start, i);
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.type='button'; btn.className='dcell';
Â  Â  Â  Â  if (d.getMonth()!==state.view.getMonth()) btn.classList.add('other');
Â  Â  Â  Â  if (sameDay(d, today)) btn.classList.add('today');
Â  Â  Â  Â  if (sameDay(d, state.sel)) btn.classList.add('sel');
Â  Â  Â  Â  btn.textContent = d.getDate();
Â  Â  Â  Â  btn.addEventListener('click', ()=>{ state.sel = d; fillGrid(); });
Â  Â  Â  Â  grid.appendChild(btn);
Â  Â  Â  }
Â  Â  Â  head.querySelector('.title').textContent = fmtMonth(state.view);
Â  Â  }

Â  Â  head.addEventListener('click', (e)=>{
Â  Â  Â  const nav = e.target.closest('[data-nav]');
Â  Â  Â  if (!nav) return;
Â  Â  Â  const dir = Number(nav.dataset.nav);
Â  Â  Â  state.view.setMonth(state.view.getMonth()+dir);
Â  Â  Â  fillGrid();
Â  Â  });

Â  Â  fillGrid();
Â  Â  return { wrapper, state, hourSel, minSel };
Â  }

Â  let portalOpen = null;
Â  function closePortal(){
Â  Â  if (!portalOpen) return;
Â  Â  const { cleanup } = portalOpen;
Â  Â  portalOpen = null;
Â  Â  if (cleanup) cleanup();
Â  Â  duePortal.style.display='none';
Â  Â  duePortal.innerHTML='';
Â  }

Â  function openPortalFor(anchorEl, taskId, currentTs){
Â  Â  closePortal();
Â  Â  duePortal.style.display='block';
Â  Â  const { wrapper, state, hourSel, minSel } = buildCalendarContent(currentTs);
Â  Â  duePortal.appendChild(wrapper);

Â  Â  function place(){
Â  Â  Â  const rect = anchorEl.getBoundingClientRect();
Â  Â  Â  const W = 320, GAP = 8;
Â  Â  Â  wrapper.style.left = Math.min(Math.max(8, rect.right - W), window.innerWidth - W - 8) + 'px';
Â  Â  Â  let top = rect.bottom + GAP;
Â  Â  Â  wrapper.style.top = top + 'px';
Â  Â  Â  const r = wrapper.getBoundingClientRect();
Â  Â  Â  if (r.bottom > window.innerHeight - 8){
Â  Â  Â  Â  top = rect.top - r.height - GAP;
Â  Â  Â  Â  if (top < 8) top = 8;
Â  Â  Â  Â  wrapper.style.top = top + 'px';
Â  Â  Â  }
Â  Â  }
Â  Â  place();

Â  Â  const onScroll = ()=>place();
Â  Â  const onResize = ()=>place();
Â  Â  window.addEventListener('scroll', onScroll, {passive:true});
Â  Â  window.addEventListener('resize', onResize, {passive:true});

Â  Â  wrapper.addEventListener('click', (e)=>{
Â  Â  Â  if (e.target.closest('[data-act=due-cancel]')){ closePortal(); e.stopPropagation(); }
Â  Â  Â  if (e.target.closest('[data-act=due-save]')){
Â  Â  Â  Â  const key = getSelected();
Â  Â  Â  Â  const arr = getTasks(key);
Â  Â  Â  Â  const idx = arr.findIndex(t=>t.id===taskId);
Â  Â  Â  Â  if (idx>=0){
Â  Â  Â  Â  Â  const sel = new Date(state.sel);
Â  Â  Â  Â  Â  sel.setHours(Number(hourSel.value), Number(minSel.value), 0, 0);
Â  Â  Â  Â  Â  arr[idx].dueAt = sel.getTime();
Â  Â  Â  Â  Â  setTasks(key, arr);
Â  Â  Â  Â  Â  renderDay(); renderCalendar();
Â  Â  Â  Â  }
Â  Â  Â  Â  closePortal(); e.stopPropagation();
Â  Â  Â  }
Â  Â  });

Â  Â  portalOpen = { cleanup: ()=>{
Â  Â  Â  window.removeEventListener('scroll', onScroll);
Â  Â  Â  window.removeEventListener('resize', onResize);
Â  Â  }};
Â  }

Â  list.addEventListener('click', (e)=>{
Â  Â  const key = getSelected();
Â  Â  const li = e.target.closest('.item'); if (!li) return;
Â  Â  const id = li.dataset.id;
Â  Â  const arr = getTasks(key);
Â  Â  const i = arr.findIndex(t=>t.id===id);

Â  Â  if (e.target.closest('[data-act=del]')){
Â  Â  Â  const newArr = arr.filter(t=>t.id!==id);
Â  Â  Â  setTasks(key, newArr); renderDay(); renderCalendar();
Â  Â  Â  return;
Â  Â  }
Â  Â  if (e.target.closest('[data-act=rep]')){
Â  Â  Â  if (i>=0){ arr[i].repeat = cycleRepeat(arr[i].repeat||'none'); setTasks(key, arr); renderDay(); }
Â  Â  Â  return;
Â  Â  }
Â  Â  if (e.target.closest('[data-act=due]')){
Â  Â  Â  const btn = e.target.closest('[data-act=due]');
Â  Â  Â  const currentTs = arr[i]?.dueAt || Date.now();
Â  Â  Â  openPortalFor(btn, id, currentTs);
Â  Â  Â  e.stopPropagation();
Â  Â  Â  return;
Â  Â  }
Â  });

Â  // ---------- Delegated clicks for header controls ----------
Â  document.addEventListener('click', (e)=>{
Â  Â  if (e.target.closest('#clearDone')){
Â  Â  Â  const key=getSelected(); const arr=getTasks(key).filter(t=>!t.done);
Â  Â  Â  setTasks(key, arr); renderDay(); renderCalendar();
Â  Â  }else if (e.target.closest('#clearAll')){
Â  Â  Â  if(!confirm('ì´ ë‚ ì§œì˜ ëª¨ë“  í•  ì¼ì„ ì‚­ì œí• ê¹Œìš”?')) return;
Â  Â  Â  const key=getSelected(); setTasks(key, []); renderDay(); renderCalendar();
Â  Â  }else if (e.target.closest('#rolloverBtn')){
Â  Â  Â  const key = getSelected();
Â  Â  Â  const nextKey = ymd(addDays(new Date(key), 1));
Â  Â  Â  const arr = getTasks(key);
Â  Â  Â  const undone = arr.filter(t=>!t.done);
Â  Â  Â  const remain = arr.filter(t=>t.done);
Â  Â  Â  setTasks(key, remain);
Â  Â  Â  const nextArr = getTasks(nextKey).concat(undone.map(t=>({ ...t })));
Â  Â  Â  setTasks(nextKey, nextArr);
Â  Â  Â  renderDay(); renderCalendar();
Â  Â  Â  alert(`ë¯¸ì™„ë£Œ ${undone.length}ê°œë¥¼ ${nextKey}ë¡œ ì´ì›”í–ˆìŠµë‹ˆë‹¤.`);
Â  Â  }
Â  });

Â  // PiP
Â  const supported = 'documentPictureInPicture' in window;
Â  document.getElementById('openPiP').addEventListener('click', async ()=>{
Â  Â  if (!supported){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ë¬¸ì„œ PiPë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
Â  Â  try{
Â  Â  Â  const pipWin = await documentPictureInPicture.requestWindow({ width: 420, height: 560 });
Â  Â  Â  [...document.styleSheets].forEach(ss=>{ try{ pipWin.document.head.appendChild(ss.ownerNode.cloneNode(true)); }catch{} });
Â  Â  Â  const tpl = document.getElementById('pip-template');
Â  Â  Â  pipWin.document.body.appendChild(pipWin.document.importNode(tpl.content, true));
Â  Â  Â  pipWin.document.title = '';

Â  Â  Â  bindPiP(pipWin.document);
Â  Â  }catch(err){
Â  Â  Â  console.error(err); alert('PiP ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err);
Â  Â  }
Â  });

Â  function bindPiP(doc){
Â  Â  const pipDate = doc.getElementById('pipDate');
Â  Â  const list = doc.getElementById('list');
Â  Â  const progText = doc.getElementById('progText');
Â  Â  const counter = doc.getElementById('counter');
Â  Â  const progBar = doc.getElementById('progBar');

Â  Â  const pipWin = doc.defaultView;
Â  Â  const pipBCÂ  = new pipWin.BroadcastChannel('CAL_TODO_SYNC_V1');

Â  Â  function pipGetSelected(){ return getSelected(pipWin); }
Â  Â  function pipGetTasks(k){ return getTasks(k, pipWin); }
Â  Â  function pipSetTasks(k, arr){ setTasks(k, arr, pipWin, pipBC); }

Â  Â  function key(){ return pipGetSelected(); }

Â  Â  function render(){
Â  Â  Â  const k = key();
Â  Â  Â  pipDate.textContent = k;
Â  Â  Â  const tasks = pipGetTasks(k);
Â  Â  Â  const total = tasks.length, done = tasks.filter(t=>t.done).length, ratio = total? Math.round(done/total*100):0;
Â  Â  Â  list.innerHTML = '';
Â  Â  Â  tasks.forEach(item => {
Â  Â  Â  Â  const li = doc.createElement('li');
Â  Â  Â  Â  li.className = 'item' + (item.done ? ' done': '');
Â  Â  Â  Â  li.dataset.id = item.id;
Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  <input type="checkbox" ${item.done?'checked':''} aria-label="ì™„ë£Œ">
Â  Â  Â  Â  Â  <div class="txtwrap"><div class="txt" spellcheck="false"></div></div>
Â  Â  Â  Â  Â  <div class="actions"></div>`;
Â  Â  Â  Â  li.querySelector('.txt').textContent = item.text;
Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  });
Â  Â  Â  progText.textContent = `ì™„ë£Œ/ì „ì²´ ${ratio}%`;
Â  Â  Â  counter.textContent = `${done} / ${total}`;
Â  Â  Â  progBar.value = ratio;
Â  Â  }

Â  Â  list.addEventListener('change', (e)=>{
Â  Â  Â  if (e.target.matches('input[type=checkbox]')){
Â  Â  Â  Â  const k = key();
Â  Â  Â  Â  const id = e.target.closest('.item')?.dataset.id;
Â  Â  Â  Â  const arr = pipGetTasks(k);
Â  Â  Â  Â  const i = arr.findIndex(t=>t.id===id);
Â  Â  Â  Â  if (i>=0){
Â  Â  Â  Â  Â  arr[i].done = !!e.target.checked;
Â  Â  Â  Â  Â  pipSetTasks(k, arr);
Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  pipBC.addEventListener('message', (m)=>{
Â  Â  Â  const t = m.data?.type;
Â  Â  Â  if (t==='tasks' || t==='date' || t==='hourly-sync'){ render(); }
Â  Â  });
Â  Â  pipWin.addEventListener('storage', (e)=>{
Â  Â  Â  if (e.key===TASKS_KEY || e.key===SEL_KEY || e.key===REV_KEY) render();
Â  Â  });

Â  Â  render();
Â  }

Â  bc.addEventListener('message', (m)=>{
Â  Â  const t=m.data?.type;
Â  Â  if (t==='tasks'){ renderDay(); renderCalendar(); }
Â  Â  if (t==='date'){ renderCalendar(); renderDay(); }
Â  Â  if (t==='hourly-sync'){ renderDay(); renderCalendar(); }
Â  });
Â  window.addEventListener('storage', (e)=>{ if (e.key===TASKS_KEY || e.key===SEL_KEY || e.key===REV_KEY){ renderDay(); renderCalendar(); } });

Â  applyTheme();
Â  requestNotify();
Â  runDailyRollover();
Â  renderCalendar();
Â  renderDay();

Â  function scheduleHourlySync(cb){
Â  Â  const now = new Date();
Â  Â  const msToNextHour = (60 - now.getMinutes())*60*1000 - now.getSeconds()*1000 - now.getMilliseconds();
Â  Â  setTimeout(()=>{ try{ cb(); }catch{}; setInterval(()=>{ try{ cb(); }catch{} }, 60*60*1000); }, Math.max(5000, msToNextHour));
Â  }
Â  scheduleHourlySync(()=>{ bc.postMessage({type:'hourly-sync'}); renderDay(); renderCalendar(); });

Â  setInterval(()=>{
Â  Â  const all = loadMap(TASKS_KEY);
Â  Â  const now = Date.now();
Â  Â  for (const key of Object.keys(all)){
Â  Â  Â  for (const t of all[key]){
Â  Â  Â  Â  if (t.dueAt && !t.done && t.dueAt <= now){
Â  Â  Â  Â  Â  maybeNotify(t, key);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }, 30000);
})();
</script>
</body>
</html>
